<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Capture Diagnostic Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 2rem;
      background: #f5f5f5;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 1rem;
    }

    .status-section {
      margin: 2rem 0;
      padding: 1rem;
      border-radius: 5px;
      background: #f8f9fa;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      margin: 0.5rem 0;
      background: white;
      border-radius: 5px;
      border-left: 4px solid #ccc;
    }

    .status-item.pass {
      border-left-color: #28a745;
    }

    .status-item.fail {
      border-left-color: #dc3545;
    }

    .status-item.warn {
      border-left-color: #ffc107;
    }

    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .badge.pass {
      background: #d4edda;
      color: #155724;
    }

    .badge.fail {
      background: #f8d7da;
      color: #721c24;
    }

    .badge.warn {
      background: #fff3cd;
      color: #856404;
    }

    .test-section {
      margin: 2rem 0;
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #0066cc;
      color: white;
    }

    .btn-primary:hover {
      background: #0052a3;
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .transcript-box {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      min-height: 100px;
      white-space: pre-wrap;
    }

    .info-box {
      padding: 1rem;
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 5px;
      color: #0c5460;
      margin: 1rem 0;
    }

    .error-box {
      padding: 1rem;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 5px;
      color: #721c24;
      margin: 1rem 0;
    }

    code {
      background: #e9ecef;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎤 Voice Capture Diagnostic Tool</h1>
    <p>This page tests if voice capture will work on your site.</p>

    <div class="status-section">
      <h2>System Status</h2>
      <div id="diagnostics"></div>
    </div>

    <div class="test-section">
      <h2>Live Test</h2>
      <p>Click the button below and speak into your microphone:</p>
      <button id="testBtn" class="btn btn-primary">🎤 Test Voice Capture</button>
      <div class="transcript-box" id="transcript">Transcript will appear here...</div>
    </div>

    <div class="test-section">
      <h2>Troubleshooting</h2>
      <div id="troubleshooting"></div>
    </div>
  </div>

  <script>
    // Run diagnostics
    function runDiagnostics() {
      const results = [];
      const diagnosticsEl = document.getElementById('diagnostics');
      const troubleshootingEl = document.getElementById('troubleshooting');

      // Check HTTPS
      const isHTTPS = window.location.protocol === 'https:';
      results.push({
        name: 'HTTPS Protocol',
        status: isHTTPS ? 'pass' : 'fail',
        message: isHTTPS
          ? `✓ Site is using HTTPS (${window.location.protocol}//)`
          : `✗ Site is using HTTP. Voice capture requires HTTPS!`,
        details: isHTTPS ? null : 'Your site MUST be served over HTTPS for voice capture to work. Contact your hosting provider or enable HTTPS in your hosting dashboard.'
      });

      // Check Speech Recognition API
      const hasWebkit = 'webkitSpeechRecognition' in window;
      const hasStandard = 'SpeechRecognition' in window;
      const hasAny = hasWebkit || hasStandard;
      results.push({
        name: 'Web Speech API',
        status: hasAny ? 'pass' : 'fail',
        message: hasAny
          ? `✓ Browser supports Web Speech API (${hasWebkit ? 'webkit' : 'standard'})`
          : '✗ Browser does not support Web Speech API',
        details: hasAny ? null : 'Try using Google Chrome or Microsoft Edge for best compatibility.'
      });

      // Check Browser
      const ua = navigator.userAgent;
      let browser = 'Unknown';
      let browserStatus = 'warn';
      let browserMessage = '';

      if (ua.includes('Chrome') && !ua.includes('Edg')) {
        browser = 'Chrome';
        browserStatus = 'pass';
        browserMessage = '✓ Chrome has excellent voice capture support';
      } else if (ua.includes('Edg')) {
        browser = 'Edge';
        browserStatus = 'pass';
        browserMessage = '✓ Edge has excellent voice capture support';
      } else if (ua.includes('Firefox')) {
        browser = 'Firefox';
        browserStatus = 'warn';
        browserMessage = '⚠ Firefox has limited support for Web Speech API';
      } else if (ua.includes('Safari')) {
        browser = 'Safari';
        browserStatus = 'warn';
        browserMessage = '⚠ Safari has limited/experimental support';
      }

      results.push({
        name: 'Browser',
        status: browserStatus,
        message: `${browser} - ${browserMessage}`,
        details: browserStatus === 'warn' ? 'For best results, use Google Chrome or Microsoft Edge.' : null
      });

      // Check permissions API (if available)
      if (navigator.permissions) {
        navigator.permissions.query({name: 'microphone'}).then(result => {
          const permStatus = result.state;
          results.push({
            name: 'Microphone Permission',
            status: permStatus === 'granted' ? 'pass' : (permStatus === 'denied' ? 'fail' : 'warn'),
            message: permStatus === 'granted'
              ? '✓ Microphone permission granted'
              : permStatus === 'denied'
              ? '✗ Microphone permission denied'
              : '⚠ Microphone permission not yet requested',
            details: permStatus === 'denied' ? 'Click the lock/info icon in your address bar and allow microphone access.' : null
          });
          renderDiagnostics(results, diagnosticsEl, troubleshootingEl);
        }).catch(() => {
          results.push({
            name: 'Microphone Permission',
            status: 'warn',
            message: '⚠ Unable to check microphone permission',
            details: 'Permission will be requested when you click the test button.'
          });
          renderDiagnostics(results, diagnosticsEl, troubleshootingEl);
        });
      } else {
        results.push({
          name: 'Microphone Permission',
          status: 'warn',
          message: '⚠ Permission API not available',
          details: 'Permission will be requested when you click the test button.'
        });
        renderDiagnostics(results, diagnosticsEl, troubleshootingEl);
      }

      // If permissions API not available, render what we have
      if (!navigator.permissions) {
        renderDiagnostics(results, diagnosticsEl, troubleshootingEl);
      }
    }

    function renderDiagnostics(results, diagnosticsEl, troubleshootingEl) {
      diagnosticsEl.innerHTML = results.map(r => `
        <div class="status-item ${r.status}">
          <span>${r.name}: ${r.message}</span>
          <span class="badge ${r.status}">${r.status.toUpperCase()}</span>
        </div>
      `).join('');

      const issues = results.filter(r => r.details);
      if (issues.length > 0) {
        troubleshootingEl.innerHTML = `
          <div class="error-box">
            <strong>Issues Found:</strong>
            <ul>
              ${issues.map(i => `<li><strong>${i.name}:</strong> ${i.details}</li>`).join('')}
            </ul>
          </div>
        `;
      } else {
        troubleshootingEl.innerHTML = `
          <div class="info-box">
            ✓ All checks passed! Your voice capture should work. Click the test button above to try it.
          </div>
        `;
      }

      // Enable/disable test button
      const canTest = results.every(r => r.status !== 'fail');
      document.getElementById('testBtn').disabled = !canTest;
    }

    // Test voice capture
    let recognition = null;
    let isListening = false;

    document.getElementById('testBtn').addEventListener('click', function() {
      if (isListening) {
        stopListening();
      } else {
        startListening();
      }
    });

    function startListening() {
      const transcriptEl = document.getElementById('transcript');
      const btn = document.getElementById('testBtn');

      try {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = true;
        recognition.continuous = true;

        recognition.onstart = () => {
          isListening = true;
          btn.textContent = '⏹ Stop Listening';
          transcriptEl.textContent = 'Listening... Speak now!';
          transcriptEl.style.background = '#d4edda';
        };

        recognition.onresult = (event) => {
          let transcript = '';
          for (let i = 0; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript + '\n';
          }
          transcriptEl.textContent = transcript || 'No speech detected yet...';
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          transcriptEl.innerHTML = `<div class="error-box">
            <strong>Error:</strong> ${event.error}<br>
            <strong>Message:</strong> ${event.message || 'Unknown error'}
          </div>`;
          stopListening();
        };

        recognition.onend = () => {
          if (isListening) {
            // Auto-restart
            recognition.start();
          }
        };

        recognition.start();
      } catch (error) {
        transcriptEl.innerHTML = `<div class="error-box">
          <strong>Failed to start:</strong> ${error.message}
        </div>`;
      }
    }

    function stopListening() {
      isListening = false;
      const btn = document.getElementById('testBtn');
      btn.textContent = '🎤 Test Voice Capture';

      if (recognition) {
        recognition.stop();
      }

      const transcriptEl = document.getElementById('transcript');
      if (transcriptEl.textContent.includes('Listening...')) {
        transcriptEl.textContent = 'Stopped. Click the button to try again.';
        transcriptEl.style.background = '#f8f9fa';
      } else {
        transcriptEl.style.background = '#f8f9fa';
      }
    }

    // Run diagnostics on page load
    runDiagnostics();
  </script>
</body>
</html>
